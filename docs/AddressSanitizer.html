
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>AddressSanitizer &#8212; Clang 11 documentation</title>
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="ThreadSanitizer" href="ThreadSanitizer.html" />
    <link rel="prev" title="Thread Safety Analysis" href="ThreadSafetyAnalysis.html" /> 
  </head>
  <body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Clang 11 documentation</span></a></h1>
        <h2 class="heading"><span>AddressSanitizer</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="ThreadSafetyAnalysis.html">Thread Safety Analysis</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ThreadSanitizer.html">ThreadSanitizer</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="addresssanitizer">
<h1>AddressSanitizer<a class="headerlink" href="#addresssanitizer" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#how-to-build" id="id2">How to build</a></li>
<li><a class="reference internal" href="#usage" id="id3">Usage</a></li>
<li><a class="reference internal" href="#symbolizing-the-reports" id="id4">Symbolizing the Reports</a></li>
<li><a class="reference internal" href="#additional-checks" id="id5">Additional Checks</a><ul>
<li><a class="reference internal" href="#initialization-order-checking" id="id6">Initialization order checking</a></li>
<li><a class="reference internal" href="#memory-leak-detection" id="id7">Memory leak detection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#issue-suppression" id="id8">Issue Suppression</a><ul>
<li><a class="reference internal" href="#suppressing-reports-in-external-libraries" id="id9">Suppressing Reports in External Libraries</a></li>
<li><a class="reference internal" href="#conditional-compilation-with-has-feature-address-sanitizer" id="id10">Conditional Compilation with <code class="docutils literal"><span class="pre">__has_feature(address_sanitizer)</span></code></a></li>
<li><a class="reference internal" href="#disabling-instrumentation-with-attribute-no-sanitize-address" id="id11">Disabling Instrumentation with <code class="docutils literal"><span class="pre">__attribute__((no_sanitize(&quot;address&quot;)))</span></code></a></li>
<li><a class="reference internal" href="#suppressing-errors-in-recompiled-code-blacklist" id="id12">Suppressing Errors in Recompiled Code (Blacklist)</a></li>
<li><a class="reference internal" href="#suppressing-memory-leaks" id="id13">Suppressing memory leaks</a></li>
</ul>
</li>
<li><a class="reference internal" href="#limitations" id="id14">Limitations</a></li>
<li><a class="reference internal" href="#supported-platforms" id="id15">Supported Platforms</a></li>
<li><a class="reference internal" href="#current-status" id="id16">Current Status</a></li>
<li><a class="reference internal" href="#more-information" id="id17">More Information</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>AddressSanitizer is a fast memory error detector. It consists of a compiler
instrumentation module and a run-time library. The tool can detect the
following types of bugs:</p>
<ul class="simple">
<li>Out-of-bounds accesses to heap, stack and globals</li>
<li>Use-after-free</li>
<li>Use-after-return (runtime flag <cite>ASAN_OPTIONS=detect_stack_use_after_return=1</cite>)</li>
<li>Use-after-scope (clang flag <cite>-fsanitize-address-use-after-scope</cite>)</li>
<li>Double-free, invalid free</li>
<li>Memory leaks (experimental)</li>
</ul>
<p>Typical slowdown introduced by AddressSanitizer is <strong>2x</strong>.</p>
</div>
<div class="section" id="how-to-build">
<h2><a class="toc-backref" href="#id2">How to build</a><a class="headerlink" href="#how-to-build" title="Permalink to this headline">¶</a></h2>
<p>Build LLVM/Clang with <a class="reference external" href="https://llvm.org/docs/CMake.html">CMake</a>.</p>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id3">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Simply compile and link your program with <code class="docutils literal"><span class="pre">-fsanitize=address</span></code> flag.  The
AddressSanitizer run-time library should be linked to the final executable, so
make sure to use <code class="docutils literal"><span class="pre">clang</span></code> (not <code class="docutils literal"><span class="pre">ld</span></code>) for the final link step.  When linking
shared libraries, the AddressSanitizer run-time is not linked, so
<code class="docutils literal"><span class="pre">-Wl,-z,defs</span></code> may cause link errors (don’t use it with AddressSanitizer).  To
get a reasonable performance add <code class="docutils literal"><span class="pre">-O1</span></code> or higher.  To get nicer stack traces
in error messages add <code class="docutils literal"><span class="pre">-fno-omit-frame-pointer</span></code>.  To get perfect stack traces
you may need to disable inlining (just use <code class="docutils literal"><span class="pre">-O1</span></code>) and tail call elimination
(<code class="docutils literal"><span class="pre">-fno-optimize-sibling-calls</span></code>).</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">%</span> cat example_UseAfterFree.cc
<span class="go">int main(int argc, char **argv) {</span>
<span class="go">  int *array = new int[100];</span>
<span class="go">  delete [] array;</span>
<span class="go">  return array[argc];  // BOOM</span>
<span class="go">}</span>

<span class="gp">#</span> Compile and link
<span class="gp">%</span> clang++ -O1 -g -fsanitize<span class="o">=</span>address -fno-omit-frame-pointer example_UseAfterFree.cc
</pre></div>
</div>
<p>or:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">#</span> Compile
<span class="gp">%</span> clang++ -O1 -g -fsanitize<span class="o">=</span>address -fno-omit-frame-pointer -c example_UseAfterFree.cc
<span class="gp">#</span> Link
<span class="gp">%</span> clang++ -g -fsanitize<span class="o">=</span>address example_UseAfterFree.o
</pre></div>
</div>
<p>If a bug is detected, the program will print an error message to stderr and
exit with a non-zero exit code. AddressSanitizer exits on the first detected error.
This is by design:</p>
<ul class="simple">
<li>This approach allows AddressSanitizer to produce faster and smaller generated code
(both by ~5%).</li>
<li>Fixing bugs becomes unavoidable. AddressSanitizer does not produce
false alarms. Once a memory corruption occurs, the program is in an inconsistent
state, which could lead to confusing results and potentially misleading
subsequent reports.</li>
</ul>
<p>If your process is sandboxed and you are running on OS X 10.10 or earlier, you
will need to set <code class="docutils literal"><span class="pre">DYLD_INSERT_LIBRARIES</span></code> environment variable and point it to
the ASan library that is packaged with the compiler used to build the
executable. (You can find the library by searching for dynamic libraries with
<code class="docutils literal"><span class="pre">asan</span></code> in their name.) If the environment variable is not set, the process will
try to re-exec. Also keep in mind that when moving the executable to another machine,
the ASan library will also need to be copied over.</p>
</div>
<div class="section" id="symbolizing-the-reports">
<h2><a class="toc-backref" href="#id4">Symbolizing the Reports</a><a class="headerlink" href="#symbolizing-the-reports" title="Permalink to this headline">¶</a></h2>
<p>To make AddressSanitizer symbolize its output
you need to set the <code class="docutils literal"><span class="pre">ASAN_SYMBOLIZER_PATH</span></code> environment variable to point to
the <code class="docutils literal"><span class="pre">llvm-symbolizer</span></code> binary (or make sure <code class="docutils literal"><span class="pre">llvm-symbolizer</span></code> is in your
<code class="docutils literal"><span class="pre">$PATH</span></code>):</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">%</span> <span class="nv">ASAN_SYMBOLIZER_PATH</span><span class="o">=</span>/usr/local/bin/llvm-symbolizer ./a.out
<span class="go">==9442== ERROR: AddressSanitizer heap-use-after-free on address 0x7f7ddab8c084 at pc 0x403c8c bp 0x7fff87fb82d0 sp 0x7fff87fb82c8</span>
<span class="go">READ of size 4 at 0x7f7ddab8c084 thread T0</span>
<span class="gp">    #</span><span class="m">0</span> 0x403c8c in main example_UseAfterFree.cc:4
<span class="gp">    #</span><span class="m">1</span> 0x7f7ddabcac4d in __libc_start_main ??:0
<span class="go">0x7f7ddab8c084 is located 4 bytes inside of 400-byte region [0x7f7ddab8c080,0x7f7ddab8c210)</span>
<span class="go">freed by thread T0 here:</span>
<span class="gp">    #</span><span class="m">0</span> 0x404704 in operator delete<span class="o">[](</span>void*<span class="o">)</span> ??:0
<span class="gp">    #</span><span class="m">1</span> 0x403c53 in main example_UseAfterFree.cc:4
<span class="gp">    #</span><span class="m">2</span> 0x7f7ddabcac4d in __libc_start_main ??:0
<span class="go">previously allocated by thread T0 here:</span>
<span class="gp">    #</span><span class="m">0</span> 0x404544 in operator new<span class="o">[](</span>unsigned long<span class="o">)</span> ??:0
<span class="gp">    #</span><span class="m">1</span> 0x403c43 in main example_UseAfterFree.cc:2
<span class="gp">    #</span><span class="m">2</span> 0x7f7ddabcac4d in __libc_start_main ??:0
<span class="go">==9442== ABORTING</span>
</pre></div>
</div>
<p>If that does not work for you (e.g. your process is sandboxed), you can use a
separate script to symbolize the result offline (online symbolization can be
force disabled by setting <code class="docutils literal"><span class="pre">ASAN_OPTIONS=symbolize=0</span></code>):</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">%</span> <span class="nv">ASAN_OPTIONS</span><span class="o">=</span><span class="nv">symbolize</span><span class="o">=</span><span class="m">0</span> ./a.out <span class="m">2</span>&gt; log
<span class="gp">%</span> projects/compiler-rt/lib/asan/scripts/asan_symbolize.py / &lt; log <span class="p">|</span> c++filt
<span class="go">==9442== ERROR: AddressSanitizer heap-use-after-free on address 0x7f7ddab8c084 at pc 0x403c8c bp 0x7fff87fb82d0 sp 0x7fff87fb82c8</span>
<span class="go">READ of size 4 at 0x7f7ddab8c084 thread T0</span>
<span class="gp">    #</span><span class="m">0</span> 0x403c8c in main example_UseAfterFree.cc:4
<span class="gp">    #</span><span class="m">1</span> 0x7f7ddabcac4d in __libc_start_main ??:0
<span class="go">...</span>
</pre></div>
</div>
<p>Note that on macOS you may need to run <code class="docutils literal"><span class="pre">dsymutil</span></code> on your binary to have the
file:line info in the AddressSanitizer reports.</p>
</div>
<div class="section" id="additional-checks">
<h2><a class="toc-backref" href="#id5">Additional Checks</a><a class="headerlink" href="#additional-checks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="initialization-order-checking">
<h3><a class="toc-backref" href="#id6">Initialization order checking</a><a class="headerlink" href="#initialization-order-checking" title="Permalink to this headline">¶</a></h3>
<p>AddressSanitizer can optionally detect dynamic initialization order problems,
when initialization of globals defined in one translation unit uses
globals defined in another translation unit. To enable this check at runtime,
you should set environment variable
<code class="docutils literal"><span class="pre">ASAN_OPTIONS=check_initialization_order=1</span></code>.</p>
<p>Note that this option is not supported on macOS.</p>
</div>
<div class="section" id="memory-leak-detection">
<h3><a class="toc-backref" href="#id7">Memory leak detection</a><a class="headerlink" href="#memory-leak-detection" title="Permalink to this headline">¶</a></h3>
<p>For more information on leak detector in AddressSanitizer, see
<a class="reference internal" href="LeakSanitizer.html"><span class="doc">LeakSanitizer</span></a>. The leak detection is turned on by default on Linux,
and can be enabled using <code class="docutils literal"><span class="pre">ASAN_OPTIONS=detect_leaks=1</span></code> on macOS;
however, it is not yet supported on other platforms.</p>
</div>
</div>
<div class="section" id="issue-suppression">
<h2><a class="toc-backref" href="#id8">Issue Suppression</a><a class="headerlink" href="#issue-suppression" title="Permalink to this headline">¶</a></h2>
<p>AddressSanitizer is not expected to produce false positives. If you see one,
look again; most likely it is a true positive!</p>
<div class="section" id="suppressing-reports-in-external-libraries">
<h3><a class="toc-backref" href="#id9">Suppressing Reports in External Libraries</a><a class="headerlink" href="#suppressing-reports-in-external-libraries" title="Permalink to this headline">¶</a></h3>
<p>Runtime interposition allows AddressSanitizer to find bugs in code that is
not being recompiled. If you run into an issue in external libraries, we
recommend immediately reporting it to the library maintainer so that it
gets addressed. However, you can use the following suppression mechanism
to unblock yourself and continue on with the testing. This suppression
mechanism should only be used for suppressing issues in external code; it
does not work on code recompiled with AddressSanitizer. To suppress errors
in external libraries, set the <code class="docutils literal"><span class="pre">ASAN_OPTIONS</span></code> environment variable to point
to a suppression file. You can either specify the full path to the file or the
path of the file relative to the location of your executable.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">ASAN_OPTIONS</span><span class="o">=</span><span class="nv">suppressions</span><span class="o">=</span>MyASan.supp
</pre></div>
</div>
<p>Use the following format to specify the names of the functions or libraries
you want to suppress. You can see these in the error report. Remember that
the narrower the scope of the suppression, the more bugs you will be able to
catch.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>interceptor_via_fun:NameOfCFunctionToSuppress
interceptor_via_fun:-<span class="o">[</span>ClassName objCMethodToSuppress:<span class="o">]</span>
interceptor_via_lib:NameOfTheLibraryToSuppress
</pre></div>
</div>
</div>
<div class="section" id="conditional-compilation-with-has-feature-address-sanitizer">
<h3><a class="toc-backref" href="#id10">Conditional Compilation with <code class="docutils literal"><span class="pre">__has_feature(address_sanitizer)</span></code></a><a class="headerlink" href="#conditional-compilation-with-has-feature-address-sanitizer" title="Permalink to this headline">¶</a></h3>
<p>In some cases one may need to execute different code depending on whether
AddressSanitizer is enabled.
<a class="reference internal" href="LanguageExtensions.html#langext-has-feature-has-extension"><span class="std std-ref">__has_feature</span></a> can be used for
this purpose.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#if defined(__has_feature)</span>
<span class="cp">#  if __has_feature(address_sanitizer)</span>
<span class="c1">// code that builds only under AddressSanitizer</span>
<span class="cp">#  endif</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<div class="section" id="disabling-instrumentation-with-attribute-no-sanitize-address">
<h3><a class="toc-backref" href="#id11">Disabling Instrumentation with <code class="docutils literal"><span class="pre">__attribute__((no_sanitize(&quot;address&quot;)))</span></code></a><a class="headerlink" href="#disabling-instrumentation-with-attribute-no-sanitize-address" title="Permalink to this headline">¶</a></h3>
<p>Some code should not be instrumented by AddressSanitizer. One may use
the attribute <code class="docutils literal"><span class="pre">__attribute__((no_sanitize(&quot;address&quot;)))</span></code> (which has
deprecated synonyms <cite>no_sanitize_address</cite> and
<cite>no_address_safety_analysis</cite>) to disable instrumentation of a
particular function. This attribute may not be supported by other
compilers, so we suggest to use it together with
<code class="docutils literal"><span class="pre">__has_feature(address_sanitizer)</span></code>.</p>
<p>The same attribute used on a global variable prevents AddressSanitizer
from adding redzones around it and detecting out of bounds accesses.</p>
</div>
<div class="section" id="suppressing-errors-in-recompiled-code-blacklist">
<h3><a class="toc-backref" href="#id12">Suppressing Errors in Recompiled Code (Blacklist)</a><a class="headerlink" href="#suppressing-errors-in-recompiled-code-blacklist" title="Permalink to this headline">¶</a></h3>
<p>AddressSanitizer supports <code class="docutils literal"><span class="pre">src</span></code> and <code class="docutils literal"><span class="pre">fun</span></code> entity types in
<a class="reference internal" href="SanitizerSpecialCaseList.html"><span class="doc">Sanitizer special case list</span></a>, that can be used to suppress error reports
in the specified source files or functions. Additionally, AddressSanitizer
introduces <code class="docutils literal"><span class="pre">global</span></code> and <code class="docutils literal"><span class="pre">type</span></code> entity types that can be used to
suppress error reports for out-of-bound access to globals with certain
names and types (you may only specify class or struct types).</p>
<p>You may use an <code class="docutils literal"><span class="pre">init</span></code> category to suppress reports about initialization-order
problems happening in certain source files or with certain global variables.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Suppress error reports for code in a file or in a function:</span>
src:bad_file.cpp
<span class="c1"># Ignore all functions with names containing MyFooBar:</span>
fun:*MyFooBar*
<span class="c1"># Disable out-of-bound checks for global:</span>
global:bad_array
<span class="c1"># Disable out-of-bound checks for global instances of a given class ...</span>
type:Namespace::BadClassName
<span class="c1"># ... or a given struct. Use wildcard to deal with anonymous namespace.</span>
type:Namespace2::*::BadStructName
<span class="c1"># Disable initialization-order checks for globals:</span>
global:bad_init_global<span class="o">=</span>init
type:*BadInitClassSubstring*<span class="o">=</span>init
src:bad/init/files/*<span class="o">=</span>init
</pre></div>
</div>
</div>
<div class="section" id="suppressing-memory-leaks">
<h3><a class="toc-backref" href="#id13">Suppressing memory leaks</a><a class="headerlink" href="#suppressing-memory-leaks" title="Permalink to this headline">¶</a></h3>
<p>Memory leak reports produced by <a class="reference internal" href="LeakSanitizer.html"><span class="doc">LeakSanitizer</span></a> (if it is run as a part
of AddressSanitizer) can be suppressed by a separate file passed as</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">LSAN_OPTIONS</span><span class="o">=</span><span class="nv">suppressions</span><span class="o">=</span>MyLSan.supp
</pre></div>
</div>
<p>which contains lines of the form <cite>leak:&lt;pattern&gt;</cite>. Memory leak will be
suppressed if pattern matches any function name, source file name, or
library name in the symbolized stack trace of the leak report. See
<a class="reference external" href="https://github.com/google/sanitizers/wiki/AddressSanitizerLeakSanitizer#suppressions">full documentation</a>
for more details.</p>
</div>
</div>
<div class="section" id="limitations">
<h2><a class="toc-backref" href="#id14">Limitations</a><a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>AddressSanitizer uses more real memory than a native run. Exact overhead
depends on the allocations sizes. The smaller the allocations you make the
bigger the overhead is.</li>
<li>AddressSanitizer uses more stack memory. We have seen up to 3x increase.</li>
<li>On 64-bit platforms AddressSanitizer maps (but not reserves) 16+ Terabytes of
virtual address space. This means that tools like <code class="docutils literal"><span class="pre">ulimit</span></code> may not work as
usually expected.</li>
<li>Static linking of executables is not supported.</li>
</ul>
</div>
<div class="section" id="supported-platforms">
<h2><a class="toc-backref" href="#id15">Supported Platforms</a><a class="headerlink" href="#supported-platforms" title="Permalink to this headline">¶</a></h2>
<p>AddressSanitizer is supported on:</p>
<ul class="simple">
<li>Linux i386/x86_64 (tested on Ubuntu 12.04)</li>
<li>macOS 10.7 - 10.11 (i386/x86_64)</li>
<li>iOS Simulator</li>
<li>Android ARM</li>
<li>NetBSD i386/x86_64</li>
<li>FreeBSD i386/x86_64 (tested on FreeBSD 11-current)</li>
<li>Windows 8.1+ (i386/x86_64)</li>
</ul>
<p>Ports to various other platforms are in progress.</p>
</div>
<div class="section" id="current-status">
<h2><a class="toc-backref" href="#id16">Current Status</a><a class="headerlink" href="#current-status" title="Permalink to this headline">¶</a></h2>
<p>AddressSanitizer is fully functional on supported platforms starting from LLVM
3.1. The test suite is integrated into CMake build and can be run with <code class="docutils literal"><span class="pre">make</span>
<span class="pre">check-asan</span></code> command.</p>
<p>The Windows port is functional and is used by Chrome and Firefox, but it is not
as well supported as the other ports.</p>
</div>
<div class="section" id="more-information">
<h2><a class="toc-backref" href="#id17">More Information</a><a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/google/sanitizers/wiki/AddressSanitizer">https://github.com/google/sanitizers/wiki/AddressSanitizer</a></p>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="ThreadSafetyAnalysis.html">Thread Safety Analysis</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ThreadSanitizer.html">ThreadSanitizer</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2007-2020, The Clang Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.
    </div>
  </body>
</html>